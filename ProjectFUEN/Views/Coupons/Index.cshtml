@using ProjectFUEN.Models.ViewModels;
@model IEnumerable<ProjectFUEN.Models.ViewModels.CouponVM>

@{
    ViewData["Title"] = "Index";
}

<h1>Coupons</h1>

<p>
    <a asp-action="Create" class="fs-4"><i class="fa-regular fa-square-plus fs-4"></i>Create</a>
</p>

<table class="table table-hover">
    <thead>
        <tr class="table-primary text-center">
            <th>
                @Html.DisplayNameFor(model => model.Code)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Name)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Discount)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.LeastCost)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Count)
            </th>
            <th>
                Send
            </th>
            <th>
            </th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
            <tr class="text-center" style="vertical-align: middle">
            <td>
                @Html.DisplayFor(modelItem => item.Code)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Discount)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.LeastCost)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Count)
            </td>
            <td>
                    <button class="btn btn-primary sendCoupon" id="@item.Code" couponName="@item.Name"><i class="fa-regular fa-envelope sendIcon"></i></button>
            </td>
            <td>
                    <a asp-action="Edit" asp-route-id="@item.Id"><i class="fa-regular fa-pen-to-square fs-5"></i></a> |
                    @*<a asp-action="Delete" asp-route-id="@item.Id"><i class="fa-regular fa-trash-can fs-5"></i></a>*@
                    <a class="deleteCoupon" id="@item.Id" couponName="@item.Name" style="cursor:pointer"><i class="fa-regular fa-trash-can fs-5"></i></a>
            </td>
        </tr>
}
    </tbody>
</table>


@section Scripts{
    <script>

        $(".sendCoupon").on("click", function () {
            let couponCode = $(this).attr("id");
            let couponName = $(this).attr("couponName");
            Swal.fire({
                title: 'Send ' + couponName,
                text: "Code: "+couponCode,
                icon: 'question',
                iconHtml: '<i class="fa-solid fa-envelope-open-text" style="font-size:50px"></i>',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, send it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(
                        'Send!',
                        'Coupon has been sent',
                        'success'
                    )
                        $.ajax({
                        type: "POST",
                        url: "https://localhost:7027/Coupons/MailToHtml",
                        data: { couponCode: couponCode }
                    }).done(function (data) {
                        //alert(data);
                    }).fail(function (err) {
                        alert(err.statusText);
                    })

                    $(this).attr('disabled', true).css({"background-color":"gray","border-color":"gray"});
                }
                    
            })
        })

        $(".deleteCoupon").on("click", function () {
            let couponId = $(this).attr("id");
            let couponName = $(this).attr("couponName");
            Swal.fire({
                title: 'Delete ' + couponName,
                text: 'Click "Yes"',
                icon: 'error',
                iconHtml: '<i class="fa-regular fa-trash-can" style="font-size:50px"></i>',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(
                        'Deleted!',
                        'Coupon has been deleted',
                        'success'
                    ).then((result) =>{
                        history.go(0);
                    })

                    $.ajax({
                        type: "Delete",
                        url: "https://localhost:7027/Coupons/DeleteCoupon",
                        data: { id: couponId },
                        async: false
                    }).done(function (data) {

                    }).fail(function (err) {
                        alert(err.statusText);
                    })
                                        
                }

            })
        })

    </script>
}